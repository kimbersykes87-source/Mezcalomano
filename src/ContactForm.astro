---
const turnstileSiteKey = typeof import.meta.env.PUBLIC_TURNSTILE_SITE_KEY === 'string'
  ? import.meta.env.PUBLIC_TURNSTILE_SITE_KEY
  : '';
---

<form class="contact-form" id="contact-form">
  <div class="form-success" id="form-success">
    <p>Thank you for your message. We'll get back to you soon.</p>
  </div>

  <div class="form-error-inline" id="form-error-inline" role="alert"></div>

  <div class="form-group">
    <input
      type="text"
      id="name"
      name="name"
      class="form-input"
      placeholder="Name"
      required
      aria-required="true"
      aria-label="Name"
    />
    <div class="form-error" id="name-error"></div>
  </div>

  <div class="form-group">
    <input
      type="email"
      id="email"
      name="email"
      class="form-input"
      placeholder="Email"
      required
      aria-required="true"
      aria-label="Email"
    />
    <div class="form-error" id="email-error"></div>
  </div>

  <div class="form-group">
    <textarea
      id="message"
      name="message"
      class="form-textarea"
      placeholder="Message"
      required
      aria-required="true"
      aria-label="Message"
    ></textarea>
    <div class="form-error" id="message-error"></div>
  </div>

  <div class="turnstile-container">
    <div id="turnstile-widget"></div>
  </div>

  <button type="submit" class="btn btn-submit">SEND MESSAGE</button>
</form>

<script define:vars={{ turnstileSiteKey }}>
  const form = document.getElementById('contact-form');
  const successMessage = document.getElementById('form-success');
  const formErrorInline = document.getElementById('form-error-inline');
  const nameInput = document.getElementById('name');
  const emailInput = document.getElementById('email');
  const messageInput = document.getElementById('message');
  const nameError = document.getElementById('name-error');
  const emailError = document.getElementById('email-error');
  const messageError = document.getElementById('message-error');
  const turnstileContainer = document.getElementById('turnstile-widget');

  let turnstileWidgetId = null;

  function showError(field, message) {
    const errorEl = field === 'name' ? nameError : field === 'email' ? emailError : messageError;
    if (errorEl) {
      errorEl.textContent = message;
      errorEl.classList.add('is-visible');
    }
  }

  function showFormError(message) {
    if (formErrorInline) {
      formErrorInline.textContent = message;
      formErrorInline.classList.add('is-visible');
    }
  }

  function clearErrors() {
    [nameError, emailError, messageError].forEach(el => {
      if (el) {
        el.textContent = '';
        el.classList.remove('is-visible');
      }
    });
    if (formErrorInline) {
      formErrorInline.textContent = '';
      formErrorInline.classList.remove('is-visible');
    }
  }

  function validateForm() {
    clearErrors();
    let isValid = true;

    if (!nameInput?.value.trim()) {
      showError('name', 'Name is required');
      isValid = false;
    }

    if (!emailInput?.value.trim()) {
      showError('email', 'Email is required');
      isValid = false;
    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value)) {
      showError('email', 'Please enter a valid email address');
      isValid = false;
    }

    if (!messageInput?.value.trim()) {
      showError('message', 'Message is required');
      isValid = false;
    }

    return isValid;
  }

  function getTurnstileToken() {
    if (!turnstileSiteKey || typeof window.turnstile === 'undefined' || turnstileWidgetId == null) return null;
    return window.turnstile.getResponse(turnstileWidgetId);
  }

  function loadTurnstile() {
    if (!turnstileSiteKey || !turnstileContainer) return;
    const script = document.createElement('script');
    script.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit';
    script.async = true;
    script.defer = true;
    script.onload = () => {
      if (window.turnstile) {
        turnstileWidgetId = window.turnstile.render(turnstileContainer, {
          sitekey: turnstileSiteKey,
          theme: 'dark',
        });
      }
    };
    document.head.appendChild(script);
  }

  loadTurnstile();

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearErrors();

      if (!validateForm()) {
        return;
      }

      const token = getTurnstileToken();
      const formData = new FormData(form);
      const data = {
        name: formData.get('name'),
        email: formData.get('email'),
        message: formData.get('message'),
        'cf-turnstile-response': token || undefined,
      };

      try {
        const response = await fetch('/api/contact', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok) {
          if (successMessage) {
            successMessage.classList.add('is-visible');
            form.reset();
            if (window.turnstile && turnstileWidgetId != null) {
              window.turnstile.reset(turnstileWidgetId);
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        } else {
          const msg = result.error || 'Something went wrong. Please try again.';
          showFormError(msg);
          if (window.turnstile && turnstileWidgetId != null) {
            window.turnstile.reset(turnstileWidgetId);
          }
        }
      } catch (error) {
        showFormError('Network error. Please try again.');
        if (window.turnstile && turnstileWidgetId != null) {
          window.turnstile.reset(turnstileWidgetId);
        }
      }
    });
  }
</script>
