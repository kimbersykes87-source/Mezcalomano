---
import BaseLayout from '../layouts/BaseLayout.astro';
import { Image } from 'astro:assets';
import matrixImage from '../../assets/photos/matrix_01_1600w.webp';
import MatrixCard from '../MatrixCard.astro';
import MatrixDrawer from '../MatrixDrawer.astro';
import matrixData from '../data/matrix.json';

// Extract unique habitats
const habitats = Array.from(new Set(matrixData.map(species => species.habitat))).sort();
---

<BaseLayout title="Matrix | MezcalÃ³mano" description="Explore 40 agave species used in mezcal production">
  <section class="hero hero--page">
    <Image
      src={matrixImage}
      alt=""
      class="hero-bg"
      loading="eager"
      formats={['webp', 'avif']}
      width={1600}
      height={1600}
    />
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <h1>Agave Matrix</h1>
      <p>Explore 40 species used in mezcal production</p>
    </div>
  </section>

  <div class="matrix-page">
    <div class="matrix-filters">
      <input
        type="text"
        class="matrix-search"
        id="matrix-search"
        placeholder="Search by name or description..."
        aria-label="Search species"
      />
      <div class="matrix-habitat-filter" id="habitat-filter">
        <button class="habitat-chip active" data-habitat="all">All</button>
        {habitats.map(habitat => (
          <button class="habitat-chip" data-habitat={habitat}>{habitat}</button>
        ))}
      </div>
    </div>

    <div class="matrix-grid" id="matrix-grid">
      {matrixData.map(species => (
        <MatrixCard species={species} />
      ))}
    </div>
  </div>

  <MatrixDrawer />

  <script define:vars={{ matrixData, habitats }}>
    const searchInput = document.getElementById('matrix-search');
    const grid = document.getElementById('matrix-grid');
    const habitatFilter = document.getElementById('habitat-filter');
    const backdrop = document.getElementById('matrix-drawer-backdrop');
    const drawer = backdrop?.querySelector('.matrix-drawer');
    let currentFilter = 'all';
    let currentSearch = '';

    // Filter and search function
    function filterSpecies() {
      const cards = grid?.querySelectorAll('.matrix-card');
      if (!cards) return;

      cards.forEach(card => {
        const speciesId = card.getAttribute('data-species-id');
        const species = matrixData.find(s => s.species_id === speciesId);
        if (!species) return;

        const matchesSearch = !currentSearch || 
          species.common_name.toLowerCase().includes(currentSearch.toLowerCase()) ||
          species.scientific_name.toLowerCase().includes(currentSearch.toLowerCase()) ||
          species.one_liner.toLowerCase().includes(currentSearch.toLowerCase());

        const matchesHabitat = currentFilter === 'all' || species.habitat === currentFilter;

        if (matchesSearch && matchesHabitat) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    }

    // Search handler
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        currentSearch = e.target.value;
        filterSpecies();
      });
    }

    // Habitat filter handler
    if (habitatFilter) {
      habitatFilter.addEventListener('click', (e) => {
        if (e.target.classList.contains('habitat-chip')) {
          const chips = habitatFilter.querySelectorAll('.habitat-chip');
          chips.forEach(chip => chip.classList.remove('active'));
          e.target.classList.add('active');
          currentFilter = e.target.getAttribute('data-habitat') || 'all';
          filterSpecies();
        }
      });
    }

    // Card click handler - open drawer
    if (grid) {
      grid.addEventListener('click', (e) => {
        const card = e.target.closest('.matrix-card');
        if (!card) return;

        const speciesId = card.getAttribute('data-species-id');
        const species = matrixData.find(s => s.species_id === speciesId);
        if (!species || !drawer) return;

        // Update drawer content
        const image = document.getElementById('drawer-image');
        const commonName = document.getElementById('drawer-common-name');
        const scientificName = document.getElementById('drawer-scientific-name');
        const oneLiner = document.getElementById('drawer-one-liner');
        const habitat = document.getElementById('drawer-habitat');
        const height = document.getElementById('drawer-height');

        if (image) {
          image.src = species.image_800;
          image.alt = `${species.common_name} (${species.scientific_name})`;
        }
        if (commonName) commonName.textContent = species.common_name;
        if (scientificName) scientificName.textContent = species.scientific_name;
        if (oneLiner) oneLiner.textContent = species.one_liner;
        if (habitat) habitat.textContent = species.habitat;
        if (height) height.textContent = species.height;

        // Open drawer
        if (backdrop) {
          backdrop.classList.add('is-open');
          document.body.style.overflow = 'hidden';
        }
      });
    }
  </script>
</BaseLayout>
