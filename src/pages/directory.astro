---
import BaseLayout from '../layouts/BaseLayout.astro';
import { Image } from 'astro:assets';
import directoryImage from '../../assets/photos/directory_1600.jpg';
import MatrixCard from '../MatrixCard.astro';
import MatrixDrawer from '../MatrixDrawer.astro';
import matrixData from '../data/matrix.json';
---

<BaseLayout title="Directory | Mezcalómano" description="Discover our guide to sourcing exceptional mezcals beyond espadín">
  <section class="hero hero--page hero--image-only">
    <Image
      src={directoryImage}
      alt=""
      class="hero-bg"
      loading="eager"
      formats={['webp', 'avif']}
      width={1600}
      height={1600}
    />
    <div class="hero-overlay"></div>
  </section>

  <div class="matrix-page">
    <div class="directory-intro">
      <h1 class="directory-title">DIRECTORY</h1>
      <p>Discover our guide to sourcing exceptional mezcals beyond espadín, like tobalá, tepeztate, and cuixe, featured in our Discovery Deck.</p>
      <p>This directory connects mezcal lovers and the mezcal curious to online retailers and brick-and-mortar venues that specialize in these rare, flavorful varieties.</p>
      <p>Use this directory to expand your mezcal journey, submit your favorite spots for inclusion to keep it growing with the community.</p>
    </div>
    <div class="matrix-filters">
      <label for="directory-search" class="matrix-search-label">SEARCH BY NAME</label>
      <input
        type="text"
        class="matrix-search"
        id="directory-search"
        placeholder="Search by name..."
        aria-label="Search species by name"
      />
    </div>

    <div class="matrix-grid" id="matrix-grid">
      {matrixData.map(species => (
        <MatrixCard species={species} />
      ))}
    </div>
  </div>

  <MatrixDrawer />

  <script define:vars={{ matrixData }}>
    const searchInput = document.getElementById('directory-search');
    const grid = document.getElementById('matrix-grid');
    const backdrop = document.getElementById('matrix-drawer-backdrop');
    const drawer = backdrop?.querySelector('.matrix-drawer');
    let currentSearch = '';

    function filterSpecies() {
      const cards = grid?.querySelectorAll('.matrix-card');
      if (!cards) return;

      cards.forEach(card => {
        const speciesId = card.getAttribute('data-species-id');
        const species = matrixData.find(s => s.species_id === speciesId);
        if (!species) return;

        const matchesSearch = !currentSearch ||
          species.common_name.toLowerCase().includes(currentSearch.toLowerCase()) ||
          species.scientific_name.toLowerCase().includes(currentSearch.toLowerCase()) ||
          species.one_liner.toLowerCase().includes(currentSearch.toLowerCase());

        if (matchesSearch) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    }

    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        currentSearch = e.target.value;
        filterSpecies();
      });
    }

    if (grid) {
      grid.addEventListener('click', (e) => {
        const card = e.target.closest('.matrix-card');
        if (!card) return;

        const speciesId = card.getAttribute('data-species-id');
        const species = matrixData.find(s => s.species_id === speciesId);
        if (!species || !drawer) return;

        const image = document.getElementById('drawer-image');
        const commonName = document.getElementById('drawer-common-name');
        const scientificName = document.getElementById('drawer-scientific-name');
        const oneLiner = document.getElementById('drawer-one-liner');
        const habitat = document.getElementById('drawer-habitat');
        const height = document.getElementById('drawer-height');

        if (image) {
          image.src = species.image_800;
          image.alt = `${species.common_name} (${species.scientific_name})`;
        }
        if (commonName) commonName.textContent = species.common_name;
        if (scientificName) scientificName.textContent = species.scientific_name;
        if (oneLiner) oneLiner.textContent = species.one_liner;
        if (habitat) habitat.textContent = species.habitat;
        if (height) height.textContent = species.height;

        if (backdrop) {
          backdrop.classList.add('is-open');
          document.body.style.overflow = 'hidden';
        }
      });
    }
  </script>
</BaseLayout>
